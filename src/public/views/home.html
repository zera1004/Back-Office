<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>배달의 민족</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.classless.min.css"
    />

    <style>
      .hamburger {
        position: fixed;
        left: 20px;
        top: 20px;
        cursor: pointer;
        padding: 10px;
        z-index: 1001;
        background-color: #fff;
        border-radius: 4px;
        transition: 0.4s;
        visibility: visible;
        opacity: 1;
      }

      .hamburger div {
        width: 25px;
        height: 3px;
        background-color: #333;
        margin: 5px 0;
        transition: 0.4s;
      }

      .sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        height: 100vh;
        width: 250px;
        transition: 0.4s;
        background-color: #fff;
        padding: 80px 15px 15px 15px;
        border: 1px solid #ddd;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        visibility: hidden;
        opacity: 0;
        display: flex;
        flex-direction: column;
      }

      .sidebar.active {
        left: 0;
        visibility: visible;
        opacity: 1;
      }

      .hamburger.active {
        left: 270px;
      }

      /* 기존 스타일 복원 */
      .header h1 {
        margin-bottom: 30px;
        text-align: center;
        color: #000;
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .header h1:hover {
        animation: refreshTitle 0.5s ease;
      }

      .navbar {
        margin-top: 30px;
        text-align: center;
        display: flex;
        justify-content: center;
        background-color: #000;
        padding: 15px 0;
        width: 100%;
      }

      .navbar ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        justify-content: center;
        gap: 30px;
      }

      .navbar li {
        display: inline-block;
      }

      .navbar a {
        color: #fff;
        text-decoration: none;
        padding: 5px 10px;
      }

      .navbar a:hover {
        color: #ccc;
      }

      /* Pico CSS 오버라이드 */
      :root:not([data-theme='dark']) {
        --background-color: #fff;
        --color: #333;
      }

      body {
        margin: 0;
        padding: 0;
        background-color: #f0f0f0;
      }

      .container {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #fff;
        min-height: 100vh;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .filter-section {
        margin-bottom: 30px;
      }

      .ranking-section {
        margin-top: auto; /* 하단에 배치 */
        padding-top: 20px;
        border-top: 1px solid #ddd;
      }

      .ranking-section h3 {
        margin: 0 0 15px 0;
        font-size: 1.1em;
        color: #333;
      }

      .ranking-list {
        margin: 0;
        padding-left: 20px;
      }

      .ranking-list li {
        margin-bottom: 10px;
        color: #666;
        font-size: 0.9em;
      }

      .ranking-list li:hover {
        color: #000;
        cursor: pointer;
      }

      /* 검색창 스타일 수정 */
      #search {
        width: 100%;
        padding: 8px 25px 8px 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 15px;
        font-size: 0.5em;
        background-color: #fff;
        color: #000;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="%23999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>');
        background-repeat: no-repeat;
        background-position: right 8px center;
        background-size: 14px;
      }

      #search::placeholder {
        font-size: 1em;
        color: #999;
      }

      #search:focus {
        outline: none;
        border-color: #999;
      }

      /* select 스타일 수정 */
      select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 15px;
        background-color: #fff;
        color: #000;
      }

      select:focus {
        outline: none;
        border-color: #999;
      }

      /* 라벨 스타일 수정 */
      label {
        display: block;
        margin-bottom: 5px;
        color: #000;
      }

      /* 이미지 컨테이너 스타일 */
      .main-image {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 40px 0;
        padding: 20px;
      }

      .main-image img {
        max-width: 400px; /* 이지 최대 너비 설정 */
        height: auto;
      }

      /* select 옵션 스타일 */
      option {
        background-color: #fff;
        color: #000;
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        position: relative;
      }

      .empty-space {
        width: 160px; /* auth-buttons와 동일한 너비로 수정 */
      }

      .header h1 {
        margin: 0;
        flex-grow: 0;
        text-align: center;
      }

      .auth-buttons {
        display: flex;
        gap: 8px;
        width: 160px; /* 전체 너비 약간 증가 */
      }

      .auth-buttons button {
        padding: 6px 14px; /* 좌우 패딩 증가 */
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.7em;
        transition: all 0.3s;
        white-space: nowrap; /* 텍스 줄바꿈 방지 */
        min-width: 60px; /* 최 너비 설정 */
      }

      .login-btn {
        background-color: transparent;
        border: 1px solid #000;
        color: #000;
      }

      .login-btn:hover {
        background-color: #f0f0f0;
      }

      .signup-btn {
        background-color: #fff;
        border: 1px solid #000;
        color: #000;
      }

      .signup-btn:hover {
        background-color: #f0f0f0;
      }

      /* 검색 결과 스타일 추가 */
      .search-results-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        padding: 20px 0;
      }

      .restaurant-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
      }

      .restaurant-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .restaurant-card h3 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 1.2em;
      }

      .restaurant-card p {
        margin: 5px 0;
        color: #666;
        font-size: 0.9em;
      }

      /* 검색 결과 없음 메시지 스타일 */
      #searchResults p {
        text-align: center;
        color: #666;
        padding: 20px;
        font-size: 1.1em;
      }

      /* 메인 컨텐츠 영역 스타일 수정 */
      .main-content {
        padding: 20px;
        min-height: 400px;
      }
    </style>
  </head>
  <body>
    <div class="hamburger" onclick="toggleSidebar()">
      <div></div>
      <div></div>
      <div></div>
    </div>

    <div class="sidebar">
      <div class="filter-section">
        <label for="region">지역</label>
        <select id="region" onchange="handleRegionChange(this.value)">
          <option value="">전체</option>
          <option value="gangnam">강남구</option>
          <option value="seocho">서초구</option>
          <option value="songpa">송파구</option>
          <option value="mapo">마포구</option>
          <option value="yongsan">용산구</option>
        </select>

        <label for="type">종류</label>
        <select id="type" onchange="handleTypeChange(this.value)">
          <option value="">음식 종류 선택</option>
          <option value="korean">한식</option>
          <option value="chinese">중식</option>
          <option value="japanese">일식</option>
          <option value="western">양식</option>
          <option value="cafe">카페</option>
          <option value="pub">술집</option>
        </select>

        <label for="search">검색</label>
        <input
          type="search"
          id="search"
          placeholder="식당 이름을 입력하세요"
          onkeyup="handleSearch(event)"
        />
      </div>

      <div class="ranking-section">
        <h3>실시간 인기 맛집</h3>
        <ol class="ranking-list" id="rankingList">
          <!-- 랭킹 데이터는 JavaScript로 동적 로드 -->
        </ol>
      </div>
    </div>

    <div class="container">
      <header class="header">
        <div class="header-content">
          <div class="empty-space"></div>
          <h1>배달의 민족</h1>
          <div class="auth-buttons">
            <div id="guest-buttons">
              <button class="login-btn" onclick="location.href='/login'">
                로그인
              </button>
              <button class="signup-btn" onclick="location.href='/signup'">
                회원가입
              </button>
            </div>
            <div id="user-buttons" style="display: none">
              <button class="mypage-btn">마이페이지</button>
              <button class="cart-btn">장바구니</button>
              <button class="logout-btn" onclick="handleLogout()">
                로그아웃
              </button>
            </div>
          </div>
        </div>
      </header>

      <nav class="navbar">
        <ul>
          <li><a href="#">홈</a></li>
          <li><a href="#">메뉴</a></li>
          <li><a href="#">리뷰</a></li>
          <li><a href="#">주문내역</a></li>
        </ul>
      </nav>

      <div class="main-content">
        <div id="searchResults"></div>
      </div>
    </div>

    <script>
      // 사이드바 토글
      function toggleSidebar() {
        const sidebar = document.querySelector('.sidebar');
        const hamburger = document.querySelector('.hamburger');
        sidebar.classList.toggle('active');
        hamburger.classList.toggle('active');
      }

      // 검색 처리 함수 수정
      async function handleSearch(event) {
        if (event.key === 'Enter') {
          const searchKeyword = event.target.value.trim().toLowerCase();
          const selectedRegion = document.getElementById('region').value;
          const selectedType = document.getElementById('type').value;

          try {
            // 검색 파라미터 구성 (종합 검색)
            const params = new URLSearchParams({
              search: searchKeyword,
            });

            // 지역과 타입이 선택된 경우 추가
            if (selectedRegion) params.append('address', selectedRegion);
            if (selectedType) params.append('type', selectedType);

            // API 호출 (/api 추가)
            const response = await fetch(`/api/restaurants/search?${params}`);
            const results = await response.json();
            displaySearchResults(results);
          } catch (error) {
            console.error('검색 오류:', error);
            alert('검색 중 오류가 발생했습니다.');
          }
        }
      }

      // 지역 필터 처리 함수 수정
      async function handleRegionChange(region) {
        try {
          // 지역이 선택되지 않은 경우 early return
          if (!region) {
            displaySearchResults([]);
            return;
          }

          // 주소 기준 검색
          const params = new URLSearchParams({
            address: region,
          });

          // API 호출
          const response = await fetch(`/api/restaurants/address?${params}`);
          const data = await response.json();

          // 서버에서 오류 메시지를 보낸 경우
          if (data.message) {
            displaySearchResults([]);
            return;
          }

          // 데이터가 배열인지 확인하고 처리
          const results = Array.isArray(data) ? data : [];
          displaySearchResults(results);
        } catch (error) {
          console.error('지역 필터 오류:', error);
          displaySearchResults([]);
        }
      }

      // 종류 필터 처리 함수 수정
      async function handleTypeChange(type) {
        try {
          // 타입이 선택되지 않은 경우 early return
          if (!type) {
            displaySearchResults([]);
            return;
          }

          // 식당 유형별 검색
          const params = new URLSearchParams({
            type: type,
          });

          // API 호출
          const response = await fetch(`/api/restaurants/type?${params}`);
          const data = await response.json();

          // 서버에서 오류 메시지를 보낸 경우
          if (data.message) {
            displaySearchResults([]);
            return;
          }

          // 데이터가 배열인지 확인하고 처리
          const results = Array.isArray(data) ? data : [];
          displaySearchResults(results);
        } catch (error) {
          console.error('종류 필터 오류:', error);
          displaySearchResults([]);
        }
      }

      // 랭킹 데이터 로드 함수 수정
      async function loadRankingData() {
        try {
          const response = await fetch('/api/restaurants/ranking');
          const data = await response.json();

          // 데이터가 배열인지 확인하고 처리
          const results = Array.isArray(data) ? data : [];

          const rankingList = document.getElementById('rankingList');
          rankingList.innerHTML = results
            .map(
              (restaurant) => `
                <li>${restaurant.restaurantName} (${restaurant.totalPoint}점)</li>
              `,
            )
            .join('');

          // 결과가 없는 경우 처리
          if (results.length === 0) {
            rankingList.innerHTML = '<li>현재 랭킹 데이터가 없습니다.</li>';
          }
        } catch (error) {
          console.error('랭킹 데이터 로드 오류:', error);
          const rankingList = document.getElementById('rankingList');
          rankingList.innerHTML =
            '<li>랭킹 데이터를 불러오는 중 오류가 발생했습니다.</li>';
        }
      }

      // 검색 결과 표시 함수는 그대로 유지
      function displaySearchResults(results) {
        const resultsContainer = document.getElementById('searchResults');
        resultsContainer.innerHTML = '';

        if (!results || results.length === 0) {
          resultsContainer.innerHTML = '<p>검색 결과가 없습니다.</p>';
          return;
        }

        const resultsList = document.createElement('div');
        resultsList.className = 'search-results-list';

        results.forEach((restaurant) => {
          const restaurantCard = document.createElement('div');
          restaurantCard.className = 'restaurant-card';
          restaurantCard.innerHTML = `
            <h3>${restaurant.restaurantName || '이름 없음'}</h3>
            <p>주소: ${restaurant.address || 'N/A'}</p>
            <p>평점: ${restaurant.totalPoint || 'N/A'}</p>
          `;
          resultsList.appendChild(restaurantCard);
        });

        resultsContainer.appendChild(resultsList);
      }

      // 로그인 상태 체크 함수
      async function checkLoginStatus() {
        try {
          const response = await fetch('/api/auth/status', {
            headers: {
              Authorization: `Bearer ${localStorage.getItem('accessToken')}`,
            },
          });

          const guestButtons = document.getElementById('guest-buttons');
          const userButtons = document.getElementById('user-buttons');

          if (response.ok) {
            const data = await response.json();
            guestButtons.style.display = 'none';
            userButtons.style.display = 'flex';

            // 사용자 타입에 따라 다른 버튼 표시
            const cartBtn = document.querySelector('.cart-btn');
            if (data.memberType === 'owner') {
              cartBtn.textContent = '매장관리';
            } else {
              cartBtn.textContent = '장바구니';
            }
          } else {
            guestButtons.style.display = 'flex';
            userButtons.style.display = 'none';
          }
        } catch (error) {
          console.error('로그인 상태 확인 실패:', error);
        }
      }

      // 로그인 처리 함수
      async function handleLogin(event) {
        event.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const memberType = document.querySelector(
          'input[name="memberType"]:checked',
        ).value;

        try {
          const response = await fetch('/api/auth/log-in', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password, memberType }),
          });

          if (response.ok) {
            const { accessToken } = await response.json();
            localStorage.setItem('accessToken', accessToken);
            await checkLoginStatus();
            closeLoginModal();
          } else {
            const error = await response.json();
            alert(error.message);
          }
        } catch (error) {
          console.error('로그인 실패:', error);
          alert('로그인 중 오류가 발생했습니다.');
        }
      }

      // 로그아웃 처리 함수
      async function handleLogout() {
        try {
          await fetch('/api/auth/log-out', {
            method: 'POST',
            headers: {
              Authorization: `Bearer ${localStorage.getItem('accessToken')}`,
            },
          });
          localStorage.removeItem('accessToken');
          await checkLoginStatus();
        } catch (error) {
          console.error('로그아웃 실패:', error);
        }
      }

      // 페이지 로드 시 실행
      document.addEventListener('DOMContentLoaded', () => {
        loadRankingData();
        checkLoginStatus(); // 로그인 상태 확인 추가

        // 로그아웃 버튼 이벤트 리스너
        const logoutBtn = document.querySelector('.logout-btn');
        if (logoutBtn) {
          logoutBtn.addEventListener('click', handleLogout);
        }
      });
    </script>
  </body>
</html>
